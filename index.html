<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ежедневный отчет</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
body {
font-family: Arial, sans-serif;
padding: 15px;
font-size: 16px;
line-height: 1.5;
}
.step { display: none; }
.active { display: block; }
table {
width: 100%;
border-collapse: collapse;
margin-top: 10px;
font-size: 14px;
display: block;
overflow-x: auto;
}
th, td {
border: 1px solid #ddd;
padding: 10px;
text-align: center;
white-space: nowrap;
}
button {
margin: 10px 5px;
padding: 12px 20px;
cursor: pointer;
font-size: 16px;
min-height: 44px;
border: none;
border-radius: 4px;
-webkit-tap-highlight-color: transparent;
}
.disabled {
background-color: gray;
color: white;
pointer-events: none;
}
.enabled {
background-color: blue;
color: white;
}
input, select {
margin: 5px;
padding: 10px;
font-size: 16px;
min-height: 44px;
width: 100%;
box-sizing: border-box;
border: 1px solid #ccc;
border-radius: 4px;
}
label {
display: block;
margin-bottom: 15px;
font-weight: bold;
}
.weights-input {
margin-bottom: 8px;
width: 100%;
}
.back-btn {
background-color: #6c757d;
color: white;
padding: 12px 20px;
border: none;
cursor: pointer;
margin-left: 10px;
min-height: 44px;
}
.back-btn:hover { background-color: #545b62; }
.nastil-section {
border: 1px solid #ccc;
padding: 15px;
margin-bottom: 20px;
border-radius: 5px;
}
.remove-nastil-btn {
background-color: red;
color: white;
padding: 8px 15px;
border: none;
cursor: pointer;
margin-top: 10px;
min-height: 44px;
}
.remove-nastil-btn:hover { background-color: darkred; }
/* Новый стиль для выравнивания кнопок “Добавить операцию” и “Отправить отчет” */
.button-row {
display: flex;
justify-content: flex-start;
gap: 10px;
margin-top: 15px;
flex-wrap: wrap;
}
/* Стиль для кнопки переключения операций */
.toggle-btn {
background-color: #28a745;
color: white;
padding: 12px 20px;
border: none;
cursor: pointer;
margin-left: 10px;
min-height: 44px;
}
.toggle-btn:hover { background-color: #218838; }
/* Стиль для кнопки “Отправить отчет” */
.submit-btn {
background-color: blue;
color: white;
}
.submit-btn:hover { background-color: darkblue; }
/* Стиль для сообщения */
#message {
display: none;
padding: 20px;
background: lightgreen;
color: green;
text-align: center;
font-size: 18px;
border-radius: 5px;
margin: 20px 0;
}
#message.error {
background: lightcoral;
color: red;
}
@media (max-width: 600px) {
body {
padding: 10px;
font-size: 18px;
}
button, input, select {
font-size: 18px;
min-height: 50px;
}
table {
font-size: 16px;
}
th, td {
padding: 12px;
}
}
@media (prefers-color-scheme: dark) {
body { color: white; }
}
</style>
</head>
<body>
<div id="message"></div>
<div id="operation-step" class="step active">
<h2>Выберите операцию</h2>
<select id="operation-select">
<option value="">Выберите…</option>
</select>
<button id="toggle-operations" class="toggle-btn">Показать все операции</button>
<button id="next-op" class="disabled">Далее</button>
</div>
<!-- Объединенный шаг для Крой и Срез -->
<div id="kroy-step" class="step">
<h2>Отчет по операции <span id="operation-name"></span></h2>
<div id="nastil-container">
<!-- Секции для каждого настила добавляются динамически -->
</div>
<button onclick="addNastil()">Добавить настил</button>
<button class="back-btn">Назад</button>
<div class="button-row">
<button onclick="addOperation()">Добавить операцию</button>
<button class="submit-btn" onclick="submitReport()">Отправить отчет</button>
</div>
</div>
<!-- Новый независимый шаг для Настил -->
<div id="nastil-step" class="step">
<h2>Отчет по операции Настил</h2>
<div id="nastil-blocks-container">
<!-- Блоки для каждого настила добавляются динамически -->
</div>
<button onclick="addNastilBlock()">Добавить настил</button>
<button class="back-btn">Назад</button>
<div class="button-row">
<button onclick="addOperation()">Добавить операцию</button>
<button class="submit-btn" onclick="submitReport()">Отправить отчет</button>
</div>
</div>
<!-- Шаги для других операций -->
<div id="other-table-step" class="step">
<h2 id="other-title">Отчет по операции …</h2>
<table id="other-table">
<thead>
<tr><th>Пачка №</th><th>Артикул</th><th>Цвет</th><th>Размер</th><th>Кол-во</th></tr>
</thead>
<tbody id="other-tbody"></tbody>
</table>
<button class="back-btn">Назад</button>
<button onclick="addRow('other')">Добавить строку</button>
<button onclick="removeRow('other')">Удалить строку</button>
<div class="button-row">
<button onclick="addOperation()">Добавить операцию</button>
<button class="submit-btn" onclick="submitReport()">Отправить отчет</button>
</div>
</div>
<!-- Специальные поля для Нарезка бейки, Отгрузка, Почасовая оплата -->
<div id="special-fields" class="step">
<div id="special-container"></div>
<button class="back-btn">Назад</button>
<div class="button-row">
<button onclick="addOperation()">Добавить операцию</button>
<button class="submit-btn" onclick="submitReport()">Отправить отчет</button>
</div>
</div>
<script>
window.addEventListener('DOMContentLoaded', function() {
// Константы (из Python)
const OPERATIONS = [
"Настил", "Срез", "Крой", "Оверлок", "Закрепка", "Распошив", "Горло", "Бейка",
"Нарезка бейки", "Упаковка", "Отгрузка", "Заготовка пояса", "Пояс Заира", "Пояс",
"Резинка", "Карман", "Подшивка низ", "Стрелка", "Переупаковка", "Выворачивание",
"Перемаркировка", "Заготовка", "Почасовая оплата"
];
const FABRIC_TYPES = ["кашкорсе", "футер двухнитка", "футер трехнитка"];
const FABRIC_COLORS = ["black", "white", "gray", "pink"];
const ARTIKULS = Array.from({length: 36}, (_, i) => `${(i+1).toString().padStart(2, '0')}/`);
const SIZES = ["38", "40", "42", "44", "46", "48", "50"];
const PACK_SIZES = ["0,5", "1"];
const tg = window.Telegram?.WebApp; 
    // Глобальные переменные
    let currentStep = 'operation-step';
    let data = { reports: [] };
    let nastilCounter = 0;
    let nastilBlockCounter = 0; // Новый счетчик для блоков Настил
    let showAllOperations = false; // Флаг для показа всех операций

    // Инициализация Telegram Web App
    tg.ready();
    const initData = tg.initDataUnsafe;
    let userOperations = OPERATIONS;
    if (initData && initData.user) {
        const urlParams = new URLSearchParams(window.location.search);
        const ops = urlParams.get('operations');
        console.log('ops from URL:', ops); // Отладка
        if (ops && ops.trim()) {
            userOperations = decodeURIComponent(ops).split(',').map(op => op.trim()).filter(op => op);
        }
    }
    console.log('userOperations after init:', userOperations.length, userOperations); // Отладка

    // Функция заполнения селекта
    function fillOperationsSelect(ops) {
        const opSelect = document.getElementById('operation-select');
        opSelect.innerHTML = '<option value="">Выберите...</option>';
        ops.forEach(op => {
            const option = document.createElement('option');
                option.value = op;
                option.textContent = op;
                opSelect.appendChild(option);
            });
        console.log('Options added, total options:', opSelect.options.length); // Отладка
    }

    // Заполняем селект по умолчанию
    fillOperationsSelect(userOperations);

    // Функция показа шага
    function showStep(stepId) {
        document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
        document.getElementById(stepId).classList.add('active');
        currentStep = stepId;
    }

    // Обработчик для кнопки "Назад"
    document.addEventListener('click', function(event) {
        if (event.target.classList.contains('back-btn')) {
            // Сбрасываем данные при возврате назад
            data.operation = null;
            data.nastils = [];
            nastilCounter = 0;
            nastilBlockCounter = 0; // Сброс счетчика блоков Настил
            document.getElementById('nastil-container').innerHTML = '';
            document.getElementById('nastil-blocks-container').innerHTML = ''; // Очистка контейнера блоков Настил
            document.getElementById('special-container').innerHTML = '';
            document.getElementById('other-tbody').innerHTML = '';
            showStep('operation-step');
        }
    });

    // Обработчики для выбора операции
    document.getElementById('operation-select').addEventListener('change', function() {
        const btn = document.getElementById('next-op');
        btn.classList.toggle('disabled', !this.value);
        btn.classList.toggle('enabled', !!this.value);
    });

    document.getElementById('next-op').addEventListener('click', function() {
        const op = document.getElementById('operation-select').value;
        if (!op) return;
        data.operation = op;
        if (op === 'Крой' || op === 'Срез') {
            nastilCounter = 0;
            data.nastils = [];
            showStep('kroy-step');
            document.getElementById('operation-name').textContent = op;
            addNastil();  // Добавить первый настил
        } else if (op === 'Настил') {
            nastilBlockCounter = 0;
            data.nastils = [];
            showStep('nastil-step');
            addNastilBlock();  // Добавить первый блок для Настил
        } else if (['Нарезка бейки', 'Отгрузка', 'Почасовая оплата'].includes(op)) {
            showStep('special-fields');
            initSpecial(op);
        } else {
            showStep('other-table-step');
            initOther(op);
        }
    });

    // Обработчик для кнопки переключения операций
    document.getElementById('toggle-operations').addEventListener('click', function() {
        showAllOperations = !showAllOperations;
        const btn = this;
        if (showAllOperations) {
            fillOperationsSelect(OPERATIONS);
            btn.textContent = 'Показать мои операции';
        } else {
            fillOperationsSelect(userOperations);
            btn.textContent = 'Показать все операции';
        }
        // Сбрасываем выбор, если текущий опшен не в новом списке
        const select = document.getElementById('operation-select');
        const currentValue = select.value;
        if (currentValue && !Array.from(select.options).some(opt => opt.value === currentValue)) {
            select.value = '';
            document.getElementById('next-op').classList.remove('enabled');
            document.getElementById('next-op').classList.add('disabled');
        }
    });

    // Функция добавления секции для настила (для Крой и Срез)
    function addNastil() {
        nastilCounter++;
        const container = document.getElementById('nastil-container');
        const section = document.createElement('div');
        section.className = 'nastil-section';
        section.id = `nastil-${nastilCounter}`;
        section.innerHTML = `
            <h3>Настил ${nastilCounter}</h3>
            <label>Тип ткани: 
                <select class="fabric-type">
                    <option value="">Выберите...</option>
                    ${FABRIC_TYPES.map(t => `<option value="${t}">${t}</option>`).join('')}
                </select>
            </label>
            <label>Цвет ткани: 
                <select class="fabric-color">
                    <option value="">Выберите...</option>
                    ${FABRIC_COLORS.map(c => `<option value="${c}">${c}</option>`).join('')}
                </select>
            </label>
            <label>Сколько пачек/рулонов ткани ушло на настил? 
                <input type="number" class="packs-count" min="1" inputmode="numeric" enterkeyhint="done">
            </label>
            <div class="weights-container"></div>
            <label>Укажите кол-во слоев в настиле: 
                <input type="number" class="layers" min="1" inputmode="numeric" enterkeyhint="done">
            </label>
            <table class="kroy-table">
                <thead>
                    <tr><th>Пачка №</th><th>Артикул</th><th>Размер</th><th>Размер пачки</th></tr>
                </thead>
                <tbody class="kroy-tbody"></tbody>
            </table>
            <button onclick="addRow(${nastilCounter})">Добавить строку</button>
            <button onclick="removeRow(${nastilCounter})">Удалить строку</button>
            <button class="remove-nastil-btn" onclick="removeNastil(${nastilCounter})">Удалить настил</button>
        `;
        container.appendChild(section);
        addRow(nastilCounter);
        section.querySelector('.packs-count').addEventListener('input', function() {
            updateWeights(nastilCounter);
        });
    }

    // Функция удаления настила (для Крой и Срез)
    function removeNastil(nastilId) {
        const section = document.getElementById(`nastil-${nastilId}`);
        if (section) {
            section.remove();
            const container = document.getElementById('nastil-container');
            const sections = container.querySelectorAll('.nastil-section');
            sections.forEach((sec, index) => {
                const newId = index + 1;
                sec.id = `nastil-${newId}`;
                sec.querySelector('h3').textContent = `Настил ${newId}`;
                sec.querySelector('.remove-nastil-btn').setAttribute('onclick', `removeNastil(${newId})`);
                sec.querySelector('button[onclick*="addRow"]').setAttribute('onclick', `addRow(${newId})`);
                sec.querySelector('button[onclick*="removeRow"]').setAttribute('onclick', `removeRow(${newId})`);
                const packsInput = sec.querySelector('.packs-count');
                packsInput.removeEventListener('input', updateWeights);
                packsInput.addEventListener('input', function() {
                    updateWeights(newId);
                });
            });
            nastilCounter = sections.length;
        }
    }

    // Функция обновления полей весов
    function updateWeights(nastilId) {
        const section = document.getElementById(`nastil-${nastilId}`);
        const count = parseInt(section.querySelector('.packs-count').value) || 0;
        const weightsContainer = section.querySelector('.weights-container');
        weightsContainer.innerHTML = '<label>Укажите вес пачек/рулонов (в кг, через запятую для десятичных):</label>';
        for (let i = 1; i <= count; i++) {
            const input = document.createElement('input');
            input.type = 'number';
            input.step = '0.01';
            input.min = '0';
            input.className = 'weights-input';
            input.placeholder = `Вес пачки ${i} (кг)`;
            input.inputMode = 'decimal';
            input.enterKeyHint = 'done';
            weightsContainer.appendChild(input);
        }
    }

    // Функция добавления блока для Настил (независимая)
    function addNastilBlock() {
        nastilBlockCounter++;
        const container = document.getElementById('nastil-blocks-container');
        const block = document.createElement('div');
        block.className = 'nastil-section';
        block.id = `nastil-block-${nastilBlockCounter}`;
        block.innerHTML = `
            <h3>Настил ${nastilBlockCounter}</h3>
            <label>Тип ткани: 
                <select class="fabric-type">
                    <option value="">Выберите...</option>
                    ${FABRIC_TYPES.map(t => `<option value="${t}">${t}</option>`).join('')}
                </select>
            </label>
            <label>Кол-во слоев: 
                <input type="number" class="layers" min="1" inputmode="numeric" enterkeyhint="done">
            </label>
            <button class="remove-nastil-btn" onclick="removeNastilBlock(${nastilBlockCounter})">Удалить настил</button>
        `;
        container.appendChild(block);
    }

    // Функция удаления блока для Настил (независимая)
    function removeNastilBlock(blockId) {
        const block = document.getElementById(`nastil-block-${blockId}`);
        if (block) {
            block.remove();
            const container = document.getElementById('nastil-blocks-container');
            const blocks = container.querySelectorAll('.nastil-section');
            blocks.forEach((blk, index) => {
                const newId = index + 1;
                blk.id = `nastil-block-${newId}`;
                blk.querySelector('h3').textContent = `Настил ${newId}`;
                blk.querySelector('.remove-nastil-btn').setAttribute('onclick', `removeNastilBlock(${newId})`);
            });
            nastilBlockCounter = blocks.length;
        }
    }

    // Функция добавления строки в таблицу
    function addRow(nastilId) {
        let tbody;
        if (nastilId === 'other') {
            tbody = document.getElementById('other-tbody');
            const row = document.createElement('tr');
            const packCell = document.createElement('td');
            const packInput = document.createElement('input');
            packInput.type = 'text';
            packInput.placeholder = 'Пачка №';
            packInput.inputMode = 'numeric';
            packInput.enterkeyHint = 'done';
            packCell.appendChild(packInput);
            row.appendChild(packCell);
            const artikulCell = document.createElement('td');
            const artikulSelect = document.createElement('select');
            artikulSelect.innerHTML = '<option value="">Выберите...</option>';
            ARTIKULS.forEach(a => {
                const option = document.createElement('option');
                option.value = a;
                option.textContent = a;
                artikulSelect.appendChild(option);
            });
            artikulCell.appendChild(artikulSelect);
            row.appendChild(artikulCell);
            const colorCell = document.createElement('td');
            const colorSelect = document.createElement('select');
            colorSelect.innerHTML = '<option value="">Выберите...</option>';
            ["black", "white", "pink", "gray"].forEach(c => {
                const option = document.createElement('option');
                option.value = c;
                option.textContent = c;
                colorSelect.appendChild(option);
            });
            colorCell.appendChild(colorSelect);
            row.appendChild(colorCell);
            const sizeCell = document.createElement('td');
            const sizeSelect = document.createElement('select');
            sizeSelect.innerHTML = '<option value="">Выберите...</option>';
            SIZES.forEach(s => {
                const option = document.createElement('option');
                option.value = s;
                option.textContent = s;
                sizeSelect.appendChild(option);
            });
            sizeCell.appendChild(sizeSelect);
            row.appendChild(sizeCell);
            const qtyCell = document.createElement('td');
            const qtyInput = document.createElement('input');
            qtyInput.type = 'number';
            qtyInput.placeholder = 'Кол-во';
            qtyInput.min = '1';
            qtyInput.inputMode = 'numeric';
            qtyInput.enterkeyHint = 'done';
            qtyCell.appendChild(qtyInput);
            row.appendChild(qtyCell);
            tbody.appendChild(row);
        } else if (nastilId === 'otgruzka') {
            tbody = document.getElementById('otgruzka-tbody');
            const row = document.createElement('tr');
            const dateCell = document.createElement('td');
            const dateInput = document.createElement('input');
            dateInput.type = 'date';
            dateCell.appendChild(dateInput);
            row.appendChild(dateCell);
            const qtyCell = document.createElement('td');
            const qtyInput = document.createElement('input');
            qtyInput.type = 'number';
            qtyInput.min = '0';
            qtyInput.step = '1';
            qtyInput.placeholder = 'Кол-во';
            qtyInput.inputMode = 'numeric';
            qtyInput.enterkeyHint = 'done';
            qtyCell.appendChild(qtyInput);
            row.appendChild(qtyCell);
            tbody.appendChild(row);
        } else {
            tbody = document.querySelector(`#nastil-${nastilId} .kroy-tbody`);
            const row = document.createElement('tr');
            const packCell = document.createElement('td');
            const packInput = document.createElement('input');
            packInput.type = 'text';
            packInput.placeholder = 'Пачка №';
            packInput.inputMode = 'numeric';
            packInput.enterkeyHint = 'done';
            packCell.appendChild(packInput);
            row.appendChild(packCell);
            const artikulCell = document.createElement('td');
            const artikulSelect = document.createElement('select');
            artikulSelect.innerHTML = '<option value="">Выберите...</option>';
            ARTIKULS.forEach(a => {
                const option = document.createElement('option');
                option.value = a;
                option.textContent = a;
                artikulSelect.appendChild(option);
            });
            artikulCell.appendChild(artikulSelect);
            row.appendChild(artikulCell);
            const sizeCell = document.createElement('td');
            const sizeSelect = document.createElement('select');
            sizeSelect.innerHTML = '<option value="">Выберите...</option>';
            SIZES.forEach(s => {
                const option = document.createElement('option');
                option.value = s;
                option.textContent = s;
                sizeSelect.appendChild(option);
            });
            sizeCell.appendChild(sizeSelect);
            row.appendChild(sizeCell);
            const packSizeCell = document.createElement('td');
            const packSizeSelect = document.createElement('select');
            packSizeSelect.innerHTML = '<option value="">Выберите...</option>';
            PACK_SIZES.forEach(p => {
                const option = document.createElement('option');
                option.value = p;
                option.textContent = p;
                packSizeSelect.appendChild(option);
            });
            packSizeCell.appendChild(packSizeSelect);
            row.appendChild(packSizeCell);
            tbody.appendChild(row);
        }
    }

    // Функция удаления строки из таблицы
    function removeRow(identifier) {
        let tbody;
        if (typeof identifier === 'number') {
            tbody = document.querySelector(`#nastil-${identifier} .kroy-tbody`);
        } else if (identifier === 'other') {
            tbody = document.getElementById('other-tbody');
        } else if (identifier === 'otgruzka') {
            tbody = document.getElementById('otgruzka-tbody');
        }
        if (tbody && tbody.lastElementChild) {
            tbody.removeChild(tbody.lastElementChild);
        }
    }

    // Инициализация для других операций
    function initOther(op) {
        document.getElementById('other-title').textContent = `Отчет по операции ${op}`;
        const tbody = document.getElementById('other-tbody');
        tbody.innerHTML = '';
        addRow('other');
    }

    function addOperation() {
    const report = { operation: data.operation };
    
    if (data.operation === 'Крой' || data.operation === 'Срез') {
        report.nastils = [];
        for (let i = 1; i <= nastilCounter; i++) {
            const section = document.getElementById(`nastil-${i}`);
            if (!section) continue;
            
            const nastilData = {
                fabric_type: section.querySelector('.fabric-type').value,
                color: section.querySelector('.fabric-color').value,
                packs_count: parseInt(section.querySelector('.packs-count').value) || 0,
                weights: Array.from(section.querySelectorAll('.weights-input')).map(inp => parseFloat(inp.value) || 0),
                layers: parseInt(section.querySelector('.layers').value) || 0,
                table: []
            };
            
            const rows = section.querySelectorAll('.kroy-tbody tr');
            rows.forEach(row => {
                const inputs = row.querySelectorAll('input, select');
                const packNum = inputs[0].value;
                const artikul = inputs[1].value;
                const size = inputs[2].value;
                const packSize = inputs[3].value;
                
                if (packNum && artikul && size && packSize) {
                    nastilData.table.push({ 
                        pack_num: packNum, 
                        artikul: artikul, 
                        size: size, 
                        pack_size: packSize 
                    });
                }
            });
            
            // Добавляем только если есть данные
            if (nastilData.fabric_type && nastilData.layers > 0 && nastilData.table.length > 0) {
                report.nastils.push(nastilData);
            }
        }
    } else if (data.operation === 'Настил') {
        report.nastils = [];
        for (let i = 1; i <= nastilBlockCounter; i++) {
            const block = document.getElementById(`nastil-block-${i}`);
            if (!block) continue;
            
            const nastilData = {
                fabric_type: block.querySelector('.fabric-type').value,
                layers: parseInt(block.querySelector('.layers').value) || 0
            };
            
            if (nastilData.fabric_type && nastilData.layers > 0) {
                report.nastils.push(nastilData);
            }
        }
    } else if (['Нарезка бейки', 'Почасовая оплата'].includes(data.operation)) {
        report.special = {};
        const container = document.getElementById('special-container');
        const inputs = container.querySelectorAll('input, select');
        
        inputs.forEach(inp => {
            if (inp.type === 'number') {
                report.special[inp.id] = parseFloat(inp.value) || 0;
            } else {
                report.special[inp.id] = inp.value;
            }
        });
    } else if (data.operation === 'Отгрузка') {
        const tbody = document.getElementById('otgruzka-tbody');
        const rows = tbody.querySelectorAll('tr');
        const shipments = [];
        
        rows.forEach(row => {
            const inputs = row.querySelectorAll('input');
            const date = inputs[0].value;
            const qty = inputs[1].value;
            
            if (date && qty) {
                shipments.push({ 
                    date: date, 
                    qty: parseInt(qty) || 0 
                });
            }
        });
        
        report.special = { shipments: shipments };
    } else {
        const tbody = document.getElementById('other-tbody');
        const rows = tbody.querySelectorAll('tr');
        const tableData = [];
        
        rows.forEach(row => {
            const inputs = row.querySelectorAll('input, select');
            const packNum = inputs[0].value;
            const artikul = inputs[1].value;
            const color = inputs[2].value;
            const size = inputs[3].value;
            const qty = inputs[4].value;
            
            if (packNum && artikul && color && size && qty) {
                tableData.push({ 
                    pack_num: packNum, 
                    artikul: artikul, 
                    color: color, 
                    size: size, 
                    qty: parseInt(qty) || 0 
                });
            }
        });
        
        report.table = tableData;
    }
    
    // Добавляем отчет только если есть данные
    const hasData = 
        (report.nastils && report.nastils.length > 0) ||
        (report.table && report.table.length > 0) ||
        (report.special && Object.keys(report.special).length > 0 && 
         ((report.special.ulitki > 0) || 
          (report.special.shipments && report.special.shipments.length > 0) ||
          (report.special.hours > 0)));
    
    if (hasData) {
        data.reports.push(report);
        alert('Операция добавлена. Данные сохранены.');
    } else {
        alert('Нет данных для сохранения. Заполните все поля.');
        return;
    }
    
    // Сброс состояния
    data.operation = null;
    data.nastils = [];
    nastilCounter = 0;
    nastilBlockCounter = 0;
    document.getElementById('nastil-container').innerHTML = '';
    document.getElementById('nastil-blocks-container').innerHTML = '';
    document.getElementById('special-container').innerHTML = '';
    document.getElementById('other-tbody').innerHTML = '';
    showStep('operation-step');
    document.getElementById('operation-select').value = '';
    document.getElementById('next-op').classList.remove('enabled');
    document.getElementById('next-op').classList.add('disabled');
}
    // Инициализация для специальных операций
    function initSpecial(op) {
        const container = document.getElementById('special-container');
        container.innerHTML = '';
        if (op === 'Нарезка бейки') {
            container.innerHTML = `
                <label>Кол-во нарезанных улиток: <input type="number" id="ulitki" min="0" step="1" inputmode="numeric" enterkeyhint="done"></label>
            `;
        } else if (op === 'Отгрузка') {
            container.innerHTML = `
                <table id="otgruzka-table">
                    <thead>
                        <tr><th>Дата отгрузки</th><th>Кол-во</th></tr>
                    </thead>
                    <tbody id="otgruzka-tbody"></tbody>
                </table>
                <button onclick="addRow('otgruzka')">Добавить отгрузку</button>
                <button onclick="removeRow('otgruzka')">Удалить строку</button>
            `;
            addRow('otgruzka');
        } else if (op === 'Почасовая оплата') {
            container.innerHTML = `
                <label>Кол-во часов работы: <input type="number" id="hours" min="0" step="0.1" inputmode="decimal" enterkeyhint="done"></label>
                <label>Оклад за 6 дней работы по 8 часов: <input type="number" id="salary" min="0" step="0.01" inputmode="decimal" enterkeyhint="done"></label>
            `;
        }
    }

function submitReport() {
    console.log("=== НАЧАЛО ОТПРАВКИ ОТЧЕТА ===");
    console.log("data.reports:", data.reports);
    console.log("data.operation:", data.operation);
    console.log("nastilCounter:", nastilCounter);
    console.log("nastilBlockCounter:", nastilBlockCounter);

    if (data.reports.length === 0 && !data.operation) {
        const messageEl = document.getElementById('message');
        messageEl.textContent = 'Произошла ошибка';
        messageEl.classList.add('error');
        messageEl.style.display = 'block';
        return;
    }

    let reportsToSend = [...data.reports];
    
    // Если есть текущая операция, добавляем ее в отчеты
    if (data.operation) {
        const report = { operation: data.operation };
        
        if (data.operation === 'Крой' || data.operation === 'Срез') {
            report.nastils = [];
            for (let i = 1; i <= nastilCounter; i++) {
                const section = document.getElementById(`nastil-${i}`);
                if (!section) continue;
                
                const nastilData = {
                    fabric_type: section.querySelector('.fabric-type').value,
                    color: section.querySelector('.fabric-color').value,
                    packs_count: parseInt(section.querySelector('.packs-count').value) || 0,
                    weights: Array.from(section.querySelectorAll('.weights-input')).map(inp => parseFloat(inp.value) || 0),
                    layers: parseInt(section.querySelector('.layers').value) || 0,
                    table: []
                };
                
                const rows = section.querySelectorAll('.kroy-tbody tr');
                rows.forEach(row => {
                    const inputs = row.querySelectorAll('input, select');
                    const packNum = inputs[0].value;
                    const artikul = inputs[1].value;
                    const size = inputs[2].value;
                    const packSize = inputs[3].value;
                    
                    if (packNum && artikul && size && packSize) {
                        nastilData.table.push({ 
                            pack_num: packNum, 
                            artikul: artikul, 
                            size: size, 
                            pack_size: packSize 
                        });
                    }
                });
                
                if (nastilData.fabric_type && nastilData.layers > 0) {
                    report.nastils.push(nastilData);
                }
            }
        } else if (data.operation === 'Настил') {
            report.nastils = [];
            for (let i = 1; i <= nastilBlockCounter; i++) {
                const block = document.getElementById(`nastil-block-${i}`);
                if (!block) continue;
                
                const nastilData = {
                    fabric_type: block.querySelector('.fabric-type').value,
                    layers: parseInt(block.querySelector('.layers').value) || 0
                };
                
                if (nastilData.fabric_type && nastilData.layers > 0) {
                    report.nastils.push(nastilData);
                }
            }
        } else if (['Нарезка бейки', 'Почасовая оплата'].includes(data.operation)) {
            report.special = {};
            const container = document.getElementById('special-container');
            const inputs = container.querySelectorAll('input, select');
            
            inputs.forEach(inp => {
                if (inp.type === 'number') {
                    report.special[inp.id] = parseFloat(inp.value) || 0;
                } else {
                    report.special[inp.id] = inp.value;
                }
            });
        } else if (data.operation === 'Отгрузка') {
            const tbody = document.getElementById('otgruzka-tbody');
            const rows = tbody.querySelectorAll('tr');
            const shipments = [];
            
            rows.forEach(row => {
                const inputs = row.querySelectorAll('input');
                const date = inputs[0].value;
                const qty = inputs[1].value;
                
                if (date && qty) {
                    shipments.push({ 
                        date: date, 
                        qty: parseInt(qty) || 0 
                    });
                }
            });
            
            report.special = { shipments: shipments };
        } else {
            // Для других операций
            const tbody = document.getElementById('other-tbody');
            const rows = tbody.querySelectorAll('tr');
            const tableData = [];
            
            rows.forEach(row => {
                const inputs = row.querySelectorAll('input, select');
                const packNum = inputs[0].value;
                const artikul = inputs[1].value;
                const color = inputs[2].value;
                const size = inputs[3].value;
                const qty = inputs[4].value;
                
                if (packNum && artikul && color && size && qty) {
                    tableData.push({ 
                        pack_num: packNum, 
                        artikul: artikul, 
                        color: color, 
                        size: size, 
                        qty: parseInt(qty) || 0 
                    });
                }
            });
            
            report.table = tableData;
        }
        
        // Добавляем только если есть данные
        if (
            (report.nastils && report.nastils.length > 0) ||
            (report.table && report.table.length > 0) ||
            (report.special && Object.keys(report.special).length > 0)
        ) {
            reportsToSend.push(report);
        }
    }

    // ПЕРЕМЕСТИТЕ ЭТИ КОНСОЛЬНЫЕ ЛОГИ СЮДА, ПОСЛЕ ТОГО КАК reportsToSend БУДЕТ ЗАПОЛНЕНА
    console.log("reportsToSend перед отправкой:", reportsToSend);
    console.log("JSON данные:", JSON.stringify(reportsToSend, null, 2));

    // Проверяем, есть ли вообще отчеты для отправки
    if (reportsToSend.length === 0) {
        const messageEl = document.getElementById('message');
        messageEl.textContent = 'Нет данных для отправки. Заполните отчет.';
        messageEl.classList.add('error');
        messageEl.style.display = 'block';
        return;
    }

    console.log("Отправляемые данные:", JSON.stringify(reportsToSend, null, 2));
    
    // Отправляем данные
    tg.sendData(JSON.stringify(reportsToSend));
    
    const messageEl = document.getElementById('message');
    messageEl.textContent = 'Отчет отправлен. Спасибо за проделанную работу!';
    messageEl.classList.remove('error');
    messageEl.style.display = 'block';
    
    setTimeout(() => tg.close(), 3000);
}

    // Добавление обработчика для скрытия клавиатуры на мобильных при нажатии Enter
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Enter' && event.target.tagName === 'INPUT') {
            event.target.blur();
        }
    });

    window.showStep = showStep;
    window.addNastil = addNastil;
    window.removeNastil = removeNastil;
    window.updateWeights = updateWeights;
    window.addNastilBlock = addNastilBlock;
    window.removeNastilBlock = removeNastilBlock;
    window.addRow = addRow;
    window.removeRow = removeRow;
    window.initOther = initOther;
    window.addOperation = addOperation;
    window.initSpecial = initSpecial;
    window.submitReport = submitReport;
});
</script>
</body>
</html>
