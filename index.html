<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Ежедневный отчет</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .step { display: none; }
        .active { display: block; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        button { margin: 10px; padding: 10px; cursor: pointer; }
        .disabled { background-color: gray; color: white; pointer-events: none; }
        .enabled { background-color: blue; color: white; }
        input, select { margin: 5px; padding: 5px; }
        label { display: block; margin-bottom: 10px; }
        .weights-input { margin-bottom: 5px; }
        .back-btn { background-color: #6c757d; color: white; padding: 10px 15px; border: none; cursor: pointer; margin-left: 10px; }
        .back-btn:hover { background-color: #545b62; }
        .nastil-section { border: 1px solid #ccc; padding: 10px; margin-bottom: 20px; }
        .remove-nastil-btn { background-color: red; color: white; padding: 5px 10px; border: none; cursor: pointer; }
        .remove-nastil-btn:hover { background-color: darkred; }
    </style>
</head>
<body>
    <div id="operation-step" class="step active">
        <h2>Выберите операцию</h2>
        <select id="operation-select">
            <option value="">Выберите...</option>
            <!-- Заполняется JS -->
        </select>
        <button id="next-op" class="disabled">Далее</button>
    </div>

    <!-- Объединенный шаг для Крой -->
    <div id="kroy-step" class="step">
        <h2>Отчет по операции Крой</h2>
        <div id="nastil-container">
            <!-- Секции для каждого настила добавляются динамически -->
        </div>
        <button onclick="addNastil()">Добавить настил</button>
        <button class="back-btn">Назад</button>
        <button onclick="submitReport()">Отправить отчет</button>
    </div>

    <!-- Шаги для других операций -->
    <div id="other-table-step" class="step">
        <h2 id="other-title">Отчет по операции ...</h2>
        <table id="other-table">
            <thead>
                <tr><th>Уникальный номер пачки</th><th>Артикул</th><th>Размер</th><th>Кол-во</th></tr>
            </thead>
            <tbody id="other-tbody"></tbody>
        </table>
        <button class="back-btn">Назад</button>
        <button onclick="addRow('other')">Добавить строку</button>
        <button onclick="removeRow('other')">Удалить строку</button>
        <button onclick="addOperation()">Добавить операцию</button>
        <button onclick="submitReport()">Отправить отчет</button>
    </div>

    <!-- Специальные поля для Настил, Нарезка бейки, Отгрузка, Почасовая оплата -->
    <div id="special-fields" class="step">
        <div id="special-container"></div>
        <button class="back-btn">Назад</button>
        <button onclick="submitReport()">Отправить отчет</button>
    </div>

    <script>
        window.addEventListener('DOMContentLoaded', function() {
            // Константы (из Python)
            const OPERATIONS = [
                "Настил", "Срез", "Крой", "Оверлок", "Закрепка", "Распошив", "Горло", "Бейка",
                "Нарезка бейки", "Упаковка", "Отгрузка", "Заготовка пояса", "Пояс Заира", "Пояс",
                "Резинка", "Карман", "Подшивка низ", "Стрелка", "Переупаковка", "Выворачивание",
                "Перемаркировка", "Заготовка", "Почасовая оплата"
            ];
            const FABRIC_TYPES = ["кашкорсе", "футер двухнитка", "футер трехнитка"];
            const FABRIC_COLORS = ["black", "white", "gray", "pink"];
            const ARTIKULS = Array.from({length: 36}, (_, i) => `${(i+1).toString().padStart(2, '0')}/`);
            const SIZES = ["38", "40", "42", "44", "46", "48", "50"];
            const PACK_SIZES = ["0,5", "1"];

            // Глобальные переменные
            let currentStep = 'operation-step';
            let data = { reports: [] };
            let nastilCounter = 0;

            // Инициализация Telegram Web App
            Telegram.WebApp.ready();
            const initData = Telegram.WebApp.initDataUnsafe;
            console.log('initData:', initData); // Отладка
            let userOperations = OPERATIONS; // Всегда инициализируем как все
            if (initData && initData.user) {
                // Если операции переданы через URL params, используем их
                const urlParams = new URLSearchParams(window.location.search);
                const ops = urlParams.get('operations');
                console.log('ops from URL:', ops); // Отладка
                if (ops && ops.trim()) {
                    userOperations = ops.split(',').map(op => op.trim()).filter(op => op);
                }
                // Иначе остаются все OPERATIONS
            }
            console.log('userOperations after init:', userOperations); // Отладка

            // Всегда заполняем селект
            const opSelect = document.getElementById('operation-select');
            console.log('opSelect:', opSelect); // Отладка
            if (opSelect && userOperations.length > 0) {
                userOperations.forEach(op => {
                    const option = document.createElement('option');
                        option.value = op;
                        option.textContent = op;
                        opSelect.appendChild(option);
                });
                console.log('Options added, total options:', opSelect.children.length); // Отладка
            } else {
                console.error('opSelect not found or userOperations empty');
            }

            // Функция показа шага
            function showStep(stepId) {
                document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
                document.getElementById(stepId).classList.add('active');
                currentStep = stepId;
            }

            // Обработчик для кнопки "Назад" через делегирование событий
            document.addEventListener('click', function(event) {
                if (event.target.classList.contains('back-btn')) {
                    showStep('operation-step');
                }
            });

            // Обработчики для выбора операции
            document.getElementById('operation-select').addEventListener('change', function() {
                const btn = document.getElementById('next-op');
                btn.classList.toggle('disabled', !this.value);
                btn.classList.toggle('enabled', !!this.value);
            });

            document.getElementById('next-op').addEventListener('click', function() {
                const op = document.getElementById('operation-select').value;
                if (!op) return;
                data.operation = op;
                if (op === 'Крой') {
                    nastilCounter = 0;
                    data.nastils = [];
                    showStep('kroy-step');
                    addNastil();  // Добавить первый настил
                } else if (['Настил', 'Нарезка бейки', 'Отгрузка', 'Почасовая оплата'].includes(op)) {
                    showStep('special-fields');
                    initSpecial(op);
                } else {
                    showStep('other-table-step');
                    initOther(op);
                }
            });

            // Функция добавления секции для настила
            function addNastil() {
                nastilCounter++;
                const container = document.getElementById('nastil-container');
                const section = document.createElement('div');
                section.className = 'nastil-section';
                section.id = `nastil-${nastilCounter}`;
                section.innerHTML = `
                    <h3>Настил ${nastilCounter}</h3>
                    <label>Тип ткани: 
                        <select class="fabric-type">
                            <option value="">Выберите...</option>
                            ${FABRIC_TYPES.map(t => `<option value="${t}">${t}</option>`).join('')}
                        </select>
                    </label>
                    <label>Цвет ткани: 
                        <select class="fabric-color">
                            <option value="">Выберите...</option>
                            ${FABRIC_COLORS.map(c => `<option value="${c}">${c}</option>`).join('')}
                        </select>
                    </label>
                    <label>Сколько пачек/рулонов ткани ушло на настил? 
                        <input type="number" class="packs-count" min="1">
                    </label>
                    <div class="weights-container"></div>
                    <label>Укажите кол-во слоев в настиле: 
                        <input type="number" class="layers" min="1">
                    </label>
                    <table class="kroy-table">
                        <thead>
                            <tr><th>Уникальный номер пачки</th><th>Артикул</th><th>Размер</th><th>Размер пачки</th></tr>
                        </thead>
                        <tbody class="kroy-tbody"></tbody>
                    </table>
                    <button onclick="addRow(${nastilCounter})">Добавить строку</button>
                    <button onclick="removeRow(${nastilCounter})">Удалить строку</button>
                    <button class="remove-nastil-btn" onclick="removeNastil(${nastilCounter})">Удалить настил</button>
                `;
                container.appendChild(section);
                // Добавить одну строку по умолчанию
                addRow(nastilCounter);
                // Обработчик для packs-count
                section.querySelector('.packs-count').addEventListener('input', function() {
                    updateWeights(nastilCounter);
                });
            }

            // Функция удаления настила
            function removeNastil(nastilId) {
                const section = document.getElementById(`nastil-${nastilId}`);
                if (section) {
                    section.remove();
                    // Пересчитать номера оставшихся настилов
                    const container = document.getElementById('nastil-container');
                    const sections = container.querySelectorAll('.nastil-section');
                    sections.forEach((sec, index) => {
                        const newId = index + 1;
                        sec.id = `nastil-${newId}`;
                        sec.querySelector('h3').textContent = `Настил ${newId}`;
                        sec.querySelector('.remove-nastil-btn').setAttribute('onclick', `removeNastil(${newId})`);
                        sec.querySelector('button[onclick*="addRow"]').setAttribute('onclick', `addRow(${newId})`);
                        sec.querySelector('button[onclick*="removeRow"]').setAttribute('onclick', `removeRow(${newId})`);
                        // Обновить обработчик для packs-count, но он уже привязан, пересоздать
                        const packsInput = sec.querySelector('.packs-count');
                        packsInput.removeEventListener('input', updateWeights); // Удалить старый
                        packsInput.addEventListener('input', function() {
                            updateWeights(newId);
                        });
                    });
                    nastilCounter = sections.length;
                }
            }

            // Функция обновления полей весов
            function updateWeights(nastilId) {
                const section = document.getElementById(`nastil-${nastilId}`);
                const count = parseInt(section.querySelector('.packs-count').value) || 0;
                const weightsContainer = section.querySelector('.weights-container');
                weightsContainer.innerHTML = '<label>Укажите вес пачек/рулонов (в кг, через запятую для десятичных):</label>';
                for (let i = 1; i <= count; i++) {
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.step = '0.01';
                    input.min = '0';
                    input.className = 'weights-input';
                    input.placeholder = `Вес пачки ${i} (кг)`;
                    weightsContainer.appendChild(input);
                }
            }

            // Функция добавления строки в таблицу
            function addRow(nastilId) {
                let tbody;
                if (nastilId === 'other') {
                    tbody = document.getElementById('other-tbody');
                    const row = document.createElement('tr');
                    // Уникальный номер пачки
                    const packCell = document.createElement('td');
                    const packInput = document.createElement('input');
                    packInput.type = 'text';
                    packInput.placeholder = 'Номер пачки';
                    packCell.appendChild(packInput);
                    row.appendChild(packCell);
                    // Артикул
                    const artikulCell = document.createElement('td');
                    const artikulSelect = document.createElement('select');
                    artikulSelect.innerHTML = '<option value="">Выберите...</option>';
                    ARTIKULS.forEach(a => {
                        const option = document.createElement('option');
                        option.value = a;
                        option.textContent = a;
                        artikulSelect.appendChild(option);
                    });
                    artikulCell.appendChild(artikulSelect);
                    row.appendChild(artikulCell);
                    // Размер
                    const sizeCell = document.createElement('td');
                    const sizeSelect = document.createElement('select');
                    sizeSelect.innerHTML = '<option value="">Выберите...</option>';
                    SIZES.forEach(s => {
                        const option = document.createElement('option');
                        option.value = s;
                        option.textContent = s;
                        sizeSelect.appendChild(option);
                    });
                    sizeCell.appendChild(sizeSelect);
                    row.appendChild(sizeCell);
                    // Кол-во
                    const qtyCell = document.createElement('td');
                    const qtyInput = document.createElement('input');
                    qtyInput.type = 'number';
                    qtyInput.placeholder = 'Кол-во';
                    qtyInput.min = '1';
                    qtyCell.appendChild(qtyInput);
                    row.appendChild(qtyCell);
                    tbody.appendChild(row);
                } else if (nastilId === 'otgruzka') {
                    tbody = document.getElementById('otgruzka-tbody');
                    const row = document.createElement('tr');
                    // Дата отгрузки
                    const dateCell = document.createElement('td');
                    const dateInput = document.createElement('input');
                    dateInput.type = 'date';
                    dateCell.appendChild(dateInput);
                    row.appendChild(dateCell);
                    // Кол-во (целые числа)
                    const qtyCell = document.createElement('td');
                    const qtyInput = document.createElement('input');
                    qtyInput.type = 'number';
                    qtyInput.min = '0';
                    qtyInput.step = '1';
                    qtyInput.placeholder = 'Кол-во';
                    qtyCell.appendChild(qtyInput);
                    row.appendChild(qtyCell);
                    tbody.appendChild(row);
                } else {
                    // Для Крой
                    tbody = document.querySelector(`#nastil-${nastilId} .kroy-tbody`);
                    const row = document.createElement('tr');
                    // Уникальный номер пачки
                    const packCell = document.createElement('td');
                    const packInput = document.createElement('input');
                    packInput.type = 'text';
                    packInput.placeholder = 'Номер пачки';
                    packCell.appendChild(packInput);
                    row.appendChild(packCell);
                    // Артикул
                    const artikulCell = document.createElement('td');
                    const artikulSelect = document.createElement('select');
                    artikulSelect.innerHTML = '<option value="">Выберите...</option>';
                    ARTIKULS.forEach(a => {
                        const option = document.createElement('option');
                        option.value = a;
                        option.textContent = a;
                        artikulSelect.appendChild(option);
                    });
                    artikulCell.appendChild(artikulSelect);
                    row.appendChild(artikulCell);
                    // Размер
                    const sizeCell = document.createElement('td');
                    const sizeSelect = document.createElement('select');
                    sizeSelect.innerHTML = '<option value="">Выберите...</option>';
                    SIZES.forEach(s => {
                        const option = document.createElement('option');
                        option.value = s;
                        option.textContent = s;
                        sizeSelect.appendChild(option);
                    });
                    sizeCell.appendChild(sizeSelect);
                    row.appendChild(sizeCell);
                    // Размер пачки
                    const packSizeCell = document.createElement('td');
                    const packSizeSelect = document.createElement('select');
                    packSizeSelect.innerHTML = '<option value="">Выберите...</option>';
                    PACK_SIZES.forEach(p => {
                        const option = document.createElement('option');
                        option.value = p;
                        option.textContent = p;
                        packSizeSelect.appendChild(option);
                    });
                    packSizeCell.appendChild(packSizeSelect);
                    row.appendChild(packSizeCell);
                    tbody.appendChild(row);
                }
            }

            // Функция удаления строки из таблицы
            function removeRow(identifier) {
                let tbody;
                if (typeof identifier === 'number') { // для настила
                    tbody = document.querySelector(`#nastil-${identifier} .kroy-tbody`);
                } else if (identifier === 'other') {
                    tbody = document.getElementById('other-tbody');
                } else if (identifier === 'otgruzka') {
                    tbody = document.getElementById('otgruzka-tbody');
                }
                if (tbody && tbody.lastElementChild) {
                    tbody.removeChild(tbody.lastElementChild);
                }
            }

            // Инициализация для других операций
            function initOther(op) {
                document.getElementById('other-title').textContent = `Отчет по операции ${op}`;
                const tbody = document.getElementById('other-tbody');
                tbody.innerHTML = '';
                addRow('other');
            }

            function addOperation() {
                // Собрать данные текущей операции и добавить в reports
                const report = { operation: data.operation };
                if (data.operation === 'Крой') {
                    report.nastils = [];
                    for (let i = 1; i <= nastilCounter; i++) {
                        const section = document.getElementById(`nastil-${i}`);
                        if (!section) continue;
                        const nastilData = {
                            fabric_type: section.querySelector('.fabric-type').value,
                            color: section.querySelector('.fabric-color').value,
                            packs_count: parseInt(section.querySelector('.packs-count').value),
                            weights: Array.from(section.querySelectorAll('.weights-input')).map(inp => inp.value),
                            layers: parseInt(section.querySelector('.layers').value),
                            table: []
                        };
                        const rows = section.querySelectorAll('.kroy-tbody tr');
                        rows.forEach(row => {
                            const inputs = row.querySelectorAll('input, select');
                            const packNum = inputs[0].value;
                            const artikul = inputs[1].value;
                            const size = inputs[2].value;
                            const packSize = inputs[3].value;
                            if (packNum && artikul && size && packSize) {
                                nastilData.table.push({ pack_num: packNum, artikul: artikul, size: size, pack_size: packSize });
                            }
                        });
                        report.nastils.push(nastilData);
                    }
                } else if (['Настил', 'Нарезка бейки', 'Почасовая оплата'].includes(data.operation)) {
                    report.special = {};
                    const container = document.getElementById('special-container');
                    const inputs = container.querySelectorAll('input, select');
                    inputs.forEach(inp => {
                        report.special[inp.id] = inp.value;
                    });
                } else if (data.operation === 'Отгрузка') {
                    const tbody = document.getElementById('otgruzka-tbody');
                    const rows = tbody.querySelectorAll('tr');
                    const shipments = [];
                    rows.forEach(row => {
                        const inputs = row.querySelectorAll('input');
                        const date = inputs[0].value;
                        const qty = inputs[1].value;
                        if (date && qty) {
                            shipments.push({ date: date, qty: qty });
                        }
                    });
                    report.special = { shipments: shipments };
                } else {
                    // Собрать данные из таблицы для других операций
                    const tbody = document.getElementById('other-tbody');
                    const rows = tbody.querySelectorAll('tr');
                    const tableData = [];
                    rows.forEach(row => {
                        const inputs = row.querySelectorAll('input, select');
                        const packNum = inputs[0].value;
                        const artikul = inputs[1].value;
                        const size = inputs[2].value;
                        const qty = inputs[3].value;
                        if (packNum && artikul && size && qty) {
                            tableData.push({ pack_num: packNum, artikul: artikul, size: size, qty: qty });
                        }
                    });
                    report.table = tableData;
                }
                data.reports.push(report);
                // Очистить текущую операцию
                data.operation = null;
                data.nastils = [];
                nastilCounter = 0;
                // Очистить контейнеры
                document.getElementById('nastil-container').innerHTML = '';
                document.getElementById('special-container').innerHTML = '';
                document.getElementById('other-tbody').innerHTML = '';
                // Вернуться к выбору операции
                showStep('operation-step');
                // Сбросить селект
                document.getElementById('operation-select').value = '';
                document.getElementById('next-op').classList.remove('enabled');
                document.getElementById('next-op').classList.add('disabled');
                alert('Операция добавлена. Данные сохранены.');
            }

            // Инициализация для специальных операций
            function initSpecial(op) {
                const container = document.getElementById('special-container');
                container.innerHTML = '';
                if (op === 'Настил') {
                    // Поля для Настила: тип ткани, кол-во слоев (без цвета ткани)
                    container.innerHTML = `
                        <label>Тип ткани: 
                            <select id="fabric-type-special">
                                <option value="">Выберите...</option>
                                ${FABRIC_TYPES.map(t => `<option value="${t}">${t}</option>`).join('')}
                            </select>
                        </label>
                        <label>Кол-во слоев: <input type="number" id="layers-special" min="1"></label>
                    `;
                } else if (op === 'Нарезка бейки') {
                    // Поле: кол-во нарезанных улиток (целое число)
                    container.innerHTML = `
                        <label>Кол-во нарезанных улиток: <input type="number" id="ulitki" min="0" step="1"></label>
                    `;
                } else if (op === 'Отгрузка') {
                    // Таблица для отгрузок: дата отгрузки, кол-во
                    container.innerHTML = `
                        <table id="otgruzka-table">
                            <thead>
                                <tr><th>Дата отгрузки</th><th>Кол-во</th></tr>
                            </thead>
                            <tbody id="otgruzka-tbody"></tbody>
                        </table>
                        <button onclick="addRow('otgruzka')">Добавить отгрузку</button>
                        <button onclick="removeRow('otgruzka')">Удалить строку</button>
                    `;
                    // Добавить одну строку по умолчанию
                    addRow('otgruzka');
                } else if (op === 'Почасовая оплата') {
                    // Поля: кол-во часов работы, оклад за 6 дней работы по 8 часов
                    container.innerHTML = `
                        <label>Кол-во часов работы: <input type="number" id="hours" min="0" step="0.1"></label>
                        <label>Оклад за 6 дней работы по 8 часов: <input type="number" id="salary" min="0" step="0.01"></label>
                    `;
                }
            }

            function submitReport() {
                // Собрать текущую операцию, если есть, и добавить в reports
                if (data.operation) {
                    const report = { operation: data.operation };
                    if (data.operation === 'Крой') {
                        report.nastils = [];
                        for (let i = 1; i <= nastilCounter; i++) {
                            const section = document.getElementById(`nastil-${i}`);
                            if (!section) continue;
                            const nastilData = {
                                fabric_type: section.querySelector('.fabric-type').value,
                                color: section.querySelector('.fabric-color').value,
                                packs_count: parseInt(section.querySelector('.packs-count').value),
                                weights: Array.from(section.querySelectorAll('.weights-input')).map(inp => inp.value),
                                layers: parseInt(section.querySelector('.layers').value),
                                table: []
                            };
                            const rows = section.querySelectorAll('.kroy-tbody tr');
                            rows.forEach(row => {
                                const inputs = row.querySelectorAll('input, select');
                                const packNum = inputs[0].value;
                                const artikul = inputs[1].value;
                                const size = inputs[2].value;
                                const packSize = inputs[3].value;
                                if (packNum && artikul && size && packSize) {
                                    nastilData.table.push({ pack_num: packNum, artikul: artikul, size: size, pack_size: packSize });
                                }
                            });
                            report.nastils.push(nastilData);
                        }
                    } else if (['Настил', 'Нарезка бейки', 'Почасовая оплата'].includes(data.operation)) {
                        report.special = {};
                        const container = document.getElementById('special-container');
                        const inputs = container.querySelectorAll('input, select');
                        inputs.forEach(inp => {
                            report.special[inp.id] = inp.value;
                        });
                    } else if (data.operation === 'Отгрузка') {
                        const tbody = document.getElementById('otgruzka-tbody');
                        const rows = tbody.querySelectorAll('tr');
                        const shipments = [];
                        rows.forEach(row => {
                            const inputs = row.querySelectorAll('input');
                            const date = inputs[0].value;
                            const qty = inputs[1].value;
                            if (date && qty) {
                                shipments.push({ date: date, qty: qty });
                            }
                        });
                        report.special = { shipments: shipments };
                    } else {
                        // Собрать данные из таблицы для других операций
                        const tbody = document.getElementById('other-tbody');
                        const rows = tbody.querySelectorAll('tr');
                        const tableData = [];
                        rows.forEach(row => {
                            const inputs = row.querySelectorAll('input, select');
                            const packNum = inputs[0].value;
                            const artikul = inputs[1].value;
                            const size = inputs[2].value;
                            const qty = inputs[3].value;
                            if (packNum && artikul && size && qty) {
                                tableData.push({ pack_num: packNum, artikul: artikul, size: size, qty: qty });
                            }
                        });
                        report.table = tableData;
                    }
                    data.reports.push(report);
                }
                // Отправить данные в Telegram Web App
                Telegram.WebApp.sendData(JSON.stringify(data.reports));
                Telegram.WebApp.close();
            }

            // Экспортируем функции в глобальную область для onclick
            window.showStep = showStep;
            window.addNastil = addNastil;
            window.removeNastil = removeNastil;
            window.updateWeights = updateWeights;
            window.addRow = addRow;
            window.removeRow = removeRow;
            window.initOther = initOther;
            window.addOperation = addOperation;
            window.initSpecial = initSpecial;
            window.submitReport = submitReport;
        });
    </script>
</body>
</html>
